#!/bin/sh
# Example:
# src/cmph -C -s 0 -a bdz tests/_words >bdz.c && tests/compile_run bdz tests/_words 10000
# ./cmph_compile_run bdz tests/_words

cd "$(dirname "$0")" || exit 1
set -e
N=10000
WORDS=/usr/share/dict/words

test -e _cwords || head -n "$N" <"${WORDS}" >_cwords
test -e _cwords1000 || head -n 1000 <"${WORDS}" >_cwords1000
test -e _cwords100 || head -n 100 <"${WORDS}" >_cwords100

while getopts "a:f:" opt
do
    case "$opt" in
        a)
            a="$OPTARG"
            ;;
        f)
            f="$OPTARG"
            ;;
        :)
            echo "Error: Option -$OPTARG requires an argument" >&2
            exit 1
            ;;
    esac
    shift $((OPTIND-1))
done

# brz bmz8
algos="chm bmz fch bdz bdz_ph chd chd_ph"
if [ -n "$a" ]; then
    algos="$a"
fi
hashes="jenkins wyhash crc32 fnv djb2 sdbm"
if [ -n "$f" ]; then
    hashes="$f"
fi

for a in $algos; do
    if [ "$a" = "bmz8" ]; then
        words=_words100
        nwords=100
    elif [ "$a" = "fch" ]; then
        rm -f _cwords1000.mph
        words=_cwords1000
        nwords=1000
    else
        words=_cwords
        nwords="$N"
    fi
    for f in $hashes; do
        fail=
        args="$f"
        base="${a}_${f}"
        echo "** cmph -C -a $a -f $f $words"
        # a retry often helps
        # shellcheck disable=SC2086
        ../src/cmph -C -a "$a" -f $f "$words" >"$base.c" || \
            ../src/cmph -C -a "$a" -f $f "$words" >"$base.c" || fail=1
        if [ -n "$fail" ]
        then
            fail=
            echo "too weak $f hash alone, add a seperate hashfunc and a seed"
            if [ $f = crc32 ]; then
                f="$f -f jenkins -s 11"
            else
                f="$f -f crc32 -s 11"
            fi
            # shellcheck disable=SC2086
            ../src/cmph -C -a "$a" -f $f "$words" >"$base.c" || fail=1
            if [ -n "$fail" ]
            then
                fail=
                echo "still too weak $f hashes, use less keys"
                if [ "$a" != "fch" ]; then
                    words=_cwords1000
                    nwords=1000
                else
                    words=_cwords100
                    nwords=100
                fi
                echo "** cmph -C -a $a -f $f $words"
                # shellcheck disable=SC2086
                ../src/cmph -C -a "$a" -f $f -o "$base.c" "$words" || fail=1
            else
                echo "see, that worked"
            fi
        fi
        if [ -z "$fail" ]
        then
            echo "** cc -O2 -Wall -Wextra -c -I@top_srcdir@/src $base.c"
            cc -O2 -Wall -Wextra -c -I"@top_srcdir@/src" "$base.c"
            echo "** compile_run $base $words"
            ./compile_run "$base" "$words" && rm "$base.c" "$base.o" || fail=1
            [ -n "$fail" ] && exit 1

            case "$a" in
                chd|bdz|bmz|fch|chd_ph|bdz_ph|bmz8|brz)
                    echo "Test ordering table"
                    echo "** cmph -Cr -a $a -f $f -o $base.c $words"
                    ../src/cmph -Cr -a "$a" -f $f -o "$base.c" "$words" || \
                        ../src/cmph -Cr -a "$a" -f $f -o "$base.c" "$words" || fail=1
                    if [ -z "$fail" ]
                    then
                        echo "** cc -O2 -Wall -Wextra -c -I@top_srcdir@/src $base.c"
                        cc -O2 -Wall -Wextra -DORDERING -c -I"@top_srcdir@/src" "$base.c"
                        echo "** compile_run $base $words $nwords"
                        ./compile_run "$base" "$words" "$nwords" && rm "$base.c" "$base.o" || fail=1
                        [ -n "$fail" ] && exit 1
                    fi
                    echo "Test reordered keyfile"
                    echo "** cmph -CR -a $a -f $f -o $base.c $words"
                    ../src/cmph -CR -a "$a" -f $f -o "$base.c" "$words" || \
                        ../src/cmph -CR -a "$a" -f $f -o "$base.c" "$words" || fail=1
                    if [ -z "$fail" ]
                    then
                        echo "** cc -O2 -Wall -Wextra -c -I@top_srcdir@/src $base.c"
                        cc -O2 -Wall -Wextra -c -I"@top_srcdir@/src" "$base.c"
                        echo "** compile_run $base ${words}_${a}.ord $nwords"
                        ./compile_run "$base" "${words}_${a}.ord" "$nwords" && rm "$base.c" "$base.o" "${words}_${a}.ord" || fail=1
                        [ -n "$fail" ] && exit 1
                    fi
                    ;;
                chm) echo "Skip ordering table test for $a" ;;
                *) echo "TODO Skip ordering table test for $a NYI" ;;
            esac
        fi

        if [ "$a" = "brz" ]; then # TODO brz cannot compile yet, but prepare
            # once again with fch
            # shellcheck disable=SC2086
            echo "** cmph -C -c 3 -a brz -f $f $words"
            ../src/cmph -C -c 3 -a brz -f $f -o "${base}_fch.c" "$words" || \
              ../src/cmph -C -c 3 -a brz -f $f -o "${base}_fch.c" "$words" || fail=1
            if [ -z "$fail" ]
            then
                echo "** cc -O2 -Wall -Wextra -c -I@top_srcdir@/src ${base}_fch.c"
                cc -O2 -Wall -Wextra -c -I"@top_srcdir@/src" "${base}_fch.c"
                echo "** compile_run ${base}_fch $words"
                ./compile_run "${base}_fch" "$words" && rm "${base}_fch.c" "${base}_fch.o" || exit 1
            fi
        fi

        if [ "$words" = "_cwords1000" -a "$a" != "fch" ]; then
            words=_cwords
            nwords="$N"
        fi

    done
done
rm -f _cwords _cwords100 _cwords1000 _cwords*.ord

rm -f bdz_sdbm.c bdz_ph_sdbm.c chd_djb2.c bdz_wyhash.c bdz_fnv.c \
   fch_sdbm.c fch_djb2.c chd_fnv.c bdz_djb2.c bmz_fnv.c bmz_jenkins.c \
   bmz_sdbm.c chd_wyhash.c bmz_crc32.c bdz_crc32.c fch_fnv.c bdz_jenkins.c \
   chd_crc32.c chd_jenkins.c bmz_djb2.c chd_sdbm.c fch_wyhash.c fch_crc32.c bmz_wyhash.c
