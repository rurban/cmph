#!/bin/sh
# Example:
# src/cmph -C -s 0 -a bdz tests/_words >bdz.c && tests/compile_run bdz tests/_words 10000
# ./cmph_compile_run bdz tests/_words

cd "$(dirname "$0")" || exit 1
set -e
N=10000
WORDS=/usr/share/dict/words

test -e _cwords || head -n "$N" <"${WORDS}" >_cwords
test -e _cwords1000 || head -n 1000 <"${WORDS}" >_cwords1000
test -e _cwords100 || head -n 100 <"${WORDS}" >_cwords100

# brz bmz8
for a in chm bmz fch bdz bdz_ph chd chd_ph; do
    if [ "$a" = "bmz8" ]; then
        words=_words100
        nwords=100
    elif [ "$a" = "fch" ]; then
        rm -f _cwords1000.mph
        words=_cwords1000
        nwords=1000
    else
        words=_cwords
        nwords="$N"
    fi
    for f in jenkins wyhash crc32 fnv djb2 sdbm; do
        fail=
        args="$f"
        base="${a}_${f}"
        echo "** cmph -C -a $a -f $f $words"
        # shellcheck disable=SC2086
        ../src/cmph -C -a "$a" -f $f "$words" >"$base.c" || fail=1
        if [ -n "$fail" ]
        then
            fail=
            echo "too weak $f hash alone, add a seperate hashfunc and a seed"
            if [ $f = crc32 ]; then
                f="$f -f jenkins -s 11"
            else
                f="$f -f crc32 -s 11"
            fi
            # shellcheck disable=SC2086
            ../src/cmph -C -a "$a" -f $f "$words" >"$base.c" || fail=1
            if [ -n "$fail" ]
            then
                fail=
                echo "still too weak $f hashes, use less keys"
                words=_cwords1000
                nwords=1000
                echo "** cmph -C -a $a -f $f $words"
                # shellcheck disable=SC2086
                ../src/cmph -C -a "$a" -f $f "$words" >"$base.c" || fail=1
            fi
        fi
        echo "** cc -O2 -Wall -Wextra -c -I@top_srcdir@/src $base.c"
        cc -O2 -Wall -Wextra -c -I"@top_srcdir@/src" "$base.c"
        echo "** compile_run $base $words $N"
        ./compile_run "$base" "$words" "$nwords" && rm "$base.c" "$base.o" || exit 1

    done
done
rm -f _cwords _cwords100 _cwords1000
